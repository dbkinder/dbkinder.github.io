

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en" > <!--<![endif]-->
  <head>
    <meta charset="utf-8">
   <!-- Google Tag Manager -->
   <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
   new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-KMP8MS');</script>
   <!-- End Google Tag Manager -->
    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/img/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/img/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/img/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/img/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/img/apple-touch-icon-120x120.png">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="../../_static/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Zephyr Project">
    <meta name="application-name" content="Zephyr Project">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    
    <title>Interrupts &mdash; Zephyr Project Documentation</title>
    

    
    

    

    
    
      
    

    
    
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    

    
      <link rel="stylesheet" href="../../_static/zephyr-custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/normalize.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/layout.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/main.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    

    
        <link rel="index" title="Index" href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
      <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Other Services" href="other.html"/>
        <link rel="next" title="Atomic Services" href="atomic.html"/>
        <link rel="prev" title="Other Services" href="other.html"/> 

    
    <script src="../../_static/js/modernizr.min.js"></script>

  </head>

  <body class="not-front page-documentation one-sidebar sidebar-first" role="document" >
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KMP8MS"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="page">
      <header id="header">
  <div class="header-wrapper">
    <div class="container">
      <a href="https://zephyrproject.org/" title="Zephyr Project" rel="home" id="logo">
        <img src="../../_static/img/logo_white.png" alt="Zephyr Project">
      </a>
      <a href="" id="navigation-toggle">
        <span> </span>
        Menu
      </a>
      <nav id="navigation" class="menu with-primary with-secondary">
        <ul class="header-menu main-menu">
          <li class="first expanded about mid-1209"><a href="https://zephyrproject.org/about/"><span>About</span></a>
            <ul class="menu">
              <li class="first leaf what-is-zephyr mid-2563"><a href="https://zephyrproject.org/what-is-zephyr/"><span>What is the Zephyr Project?</span></a></li>
              <li class="leaf organization mid-2564"><a href="https://zephyrproject.org/about/organization/"><span>Organization</span></a></li>
              <li class="leaf memberships mid-2532"><a href="https://zephyrproject.org/#members"><span>Members</span></a></li>
              <li class="leaf faq mid-2525"><a href="https://zephyrproject.org/about/#faq"><span>FAQ</span></a></li>
              <li class="leaf join mid-2622"><a href="https://zephyrproject.org/join/"><span>Join</span></a></li>
              <li class="last leaf contact-us mid-2530"><a href="https://zephyrproject.org/about/#contact-us"><span>Contact Us</span></a></li>
            </ul>
          </li>
          <li class="expanded developers mid-1209"><a href="https://zephyrproject.org/developers/"><span>Developers</span></a>
            <ul class="menu">
              <li class="first expanded leaf code mid-2563"><a href="https://github.com/zephyrproject-rtos/zephyr/" target="_blank"><span>Code</span></a></li>
              <li class="leaf downloads mid-2564"><a href="https://zephyrproject.org/developers/#downloads"><span>Downloads</span></a></li>
              <li class="leaf documentation mid-2564"><a href="http://docs.zephyrproject.org/index.html" target="_blank"><span>Documentation</span></a></li>
              <li class="leaf supported-boards mid-2564"><a href="http://docs.zephyrproject.org/boards/boards.html" target="_blank"><span>Supported Boards</span></a></li>
              <li class="leaf releases-overview mid-2564"><a href="https://zephyrproject.org/developers/#releases-overview"><span>Releases Overview</span></a></li>
              <li class="leaf how-to-contribute mid-2564"><a href="https://zephyrproject.org/developers/how-to-contribute/"><span>How to Contribute</span></a></li>
              <li class="last leaf community-guidelines mid-2564"><a href="https://zephyrproject.org/developers/how-to-contribute/#community-guidelines"><span>Community Guidelines</span></a></li>
            </ul>
          </li>
          <li class="expanded news mid-1209"><a href="https://zephyrproject.org/news/"><span>News</span></a>
            <ul class="menu">
              <li class="first leaf announcements mid-2563"><a href="https://zephyrproject.org/news/announcements/"><span>Announcements</span></a></li>
              <li class="leaf blog mid-2563"><a href="https://zephyrproject.org/news/blog/"><span>Blog</span></a></li>
              <li class="last leaf events mid-2563"><a href="https://zephyrproject.org/events/"><span>Events</span></a></li>
            </ul>
          </li>
          <li class="last expanded project-resources mid-1209"><a href="https://zephyrproject.org/project-resources/"><span>Project Resources</span></a>
            <ul class="menu">
              <li class="first leaf presentations mid-2563"><a href="https://zephyrproject.org/project-resources/presentations/"><span>Presentations</span></a></li>
              <li class="leaf videos mid-2563"><a href="https://zephyrproject.org/project-resources/videos/"><span>Videos</span></a></li>
              <li class="leaf demos mid-2563"><a href="https://zephyrproject.org/project-resources/demos/"><span>Demos</span></a></li>
              <li class="leaf zephyr-in-market mid-2563"><a href="https://zephyrproject.org/project-resources/zephyr-in-market/"><span>Zephyr in Market</span></a></li>
              <li class="last leaf developer-tools mid-2563"><a href="https://zephyrproject.org/project-resources/developer-tools/"><span>Developer Tools</span></a></li>
            </ul>
          </li>
        </ul>
      </nav><!-- /navigation -->
    </div>
  </div>
</header><!-- /header -->
      <!-- STARTS #main -->
      <div id="main">
        <!-- STARTS .main-container -->
        <div class="main-container">
          

 



<!-- Docs -->





<div id="breadcrumb">
  <div class="container">
    <a href="/">Home</a> / 
    <a href="../../index.html">Docs</a> /
      
          <a href="../kernel.html">Zephyr Kernel Primer</a> /
      
          <a href="other.html">Other Services</a> /
      
  </div>
</div>
          <aside id="sidebar-first" class="container-sidebar">
            
            <span id="secondary-menu-button" class="">Documentation</span>
<div class="region region-sidebar">
  <div class="docs-menu">
  
    
    
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/contribute.html">Contributing to the Zephyr Project</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../kernel.html">Zephyr Kernel Primer</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads/threads.html">Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing/timing.html">Timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/memory.html">Memory Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../synchronization/synchronization.html">Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_passing/data_passing.html">Data Passing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usermode/usermode.html">User Mode</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="other.html">Other Services</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">Interrupts</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic.html">Atomic Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="polling.html">Polling API</a></li>
<li class="toctree-l3"><a class="reference internal" href="ring_buffers.html">Ring Buffers</a></li>
<li class="toctree-l3"><a class="reference internal" href="float.html">Floating Point Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="cxx_support.html">C++ Support for Applications</a></li>
<li class="toctree-l3"><a class="reference internal" href="cpu_idle.html">CPU Idling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security/security.html">Zephyr Project Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devices/index.html">Device and Driver Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystems/subsystems.html">Subsystems</a></li>
</ul>

    
  
  </div>
<div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
</div>
          </aside>
          <!-- STARTS .content SECTION-->
          <section id="content" class="row">
            
	    
            <div class="rst-content">
              <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                <div itemprop="articleBody">
                  
  <div class="section" id="interrupts">
<span id="interrupts-v2"></span><h1>Interrupts<a class="headerlink" href="#interrupts" title="Permalink to this headline">¶</a></h1>
<p>An <em class="dfn">interrupt service routine</em> (ISR) is a function that executes
asynchronously in response to a hardware or software interrupt.
An ISR normally preempts the execution of the current thread,
allowing the response to occur with very low overhead.
Thread execution resumes only once all ISR work has been completed.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#concepts" id="id1">Concepts</a><ul>
<li><a class="reference internal" href="#preventing-interruptions" id="id2">Preventing Interruptions</a></li>
<li><a class="reference internal" href="#offloading-isr-work" id="id3">Offloading ISR Work</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation" id="id4">Implementation</a><ul>
<li><a class="reference internal" href="#defining-a-regular-isr" id="id5">Defining a regular ISR</a></li>
<li><a class="reference internal" href="#defining-a-direct-isr" id="id6">Defining a ‘direct’ ISR</a></li>
<li><a class="reference internal" href="#implementation-details" id="id7">Implementation Details</a></li>
</ul>
</li>
<li><a class="reference internal" href="#suggested-uses" id="id8">Suggested Uses</a></li>
<li><a class="reference internal" href="#configuration-options" id="id9">Configuration Options</a></li>
<li><a class="reference internal" href="#apis" id="id10">APIs</a></li>
</ul>
</div>
<div class="section" id="concepts">
<h2><a class="toc-backref" href="#id1">Concepts</a><a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>Any number of ISRs can be defined, subject to the constraints imposed
by underlying hardware.</p>
<p>An ISR has the following key properties:</p>
<ul class="simple">
<li>An <strong>interrupt request (IRQ) signal</strong> that triggers the ISR.</li>
<li>A <strong>priority level</strong> associated with the IRQ.</li>
<li>An <strong>interrupt handler function</strong> that is invoked to handle the interrupt.</li>
<li>An <strong>argument value</strong> that is passed to that function.</li>
</ul>
<p>An <abbr title="Interrupt Descriptor Table">IDT</abbr> or a vector table is used
to associate a given interrupt source with a given ISR.
Only a single ISR can be associated with a specific IRQ at any given time.</p>
<p>Multiple ISRs can utilize the same function to process interrupts,
allowing a single function to service a device that generates
multiple types of interrupts or to service multiple devices
(usually of the same type). The argument value passed to an ISR’s function
allows the function to determine which interrupt has been signaled.</p>
<p>The kernel provides a default ISR for all unused IDT entries. This ISR
generates a fatal system error if an unexpected interrupt is signaled.</p>
<p>The kernel supports <strong>interrupt nesting</strong>. This allows an ISR to be preempted
in mid-execution if a higher priority interrupt is signaled. The lower
priority ISR resumes execution once the higher priority ISR has completed
its processing.</p>
<p>An ISR’s interrupt handler function executes in the kernel’s <strong>interrupt
context</strong>. This context has its own dedicated stack area (or, on some
architectures, stack areas). The size of the interrupt context stack must be
capable of handling the execution of multiple concurrent ISRs if interrupt
nesting support is enabled.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Many kernel APIs can be used only by threads, and not by ISRs. In cases
where a routine may be invoked by both threads and ISRs the kernel
provides the <a class="reference internal" href="../../api/kernel_api.html#_CPPv211k_is_in_isrv" title="k_is_in_isr"><code class="xref cpp cpp-func docutils literal"><span class="pre">k_is_in_isr()</span></code></a> API to allow the routine to
alter its behavior depending on whether it is executing as part of
a thread or as part of an ISR.</p>
</div>
<div class="section" id="preventing-interruptions">
<h3><a class="toc-backref" href="#id2">Preventing Interruptions</a><a class="headerlink" href="#preventing-interruptions" title="Permalink to this headline">¶</a></h3>
<p>In certain situations it may be necessary for the current thread to
prevent ISRs from executing while it is performing time-sensitive
or critical section operations.</p>
<p>A thread may temporarily prevent all IRQ handling in the system using
an <strong>IRQ lock</strong>. This lock can be applied even when it is already in effect,
so routines can use it without having to know if it is already in effect.
The thread must unlock its IRQ lock the same number of times it was locked
before interrupts can be once again processed by the kernel while the thread
is running.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p>The IRQ lock is thread-specific. If thread A locks out interrupts
then performs an operation that allows thread B to run
(e.g. giving a semaphore or sleeping for N milliseconds), the thread’s
IRQ lock no longer applies once thread A is swapped out. This means
that interrupts can be processed while thread B is running unless
thread B has also locked out interrupts using its own IRQ lock.
(Whether interrupts can be processed while the kernel is switching
between two threads that are using the IRQ lock is architecture-specific.)</p>
<p class="last">When thread A eventually becomes the current thread once again, the kernel
re-establishes thread A’s IRQ lock. This ensures thread A won’t be
interrupted until it has explicitly unlocked its IRQ lock.</p>
</div>
<p>Alternatively, a thread may temporarily <strong>disable</strong> a specified IRQ
so its associated ISR does not execute when the IRQ is signaled.
The IRQ must be subsequently <strong>enabled</strong> to permit the ISR to execute.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">Disabling an IRQ prevents <em>all</em> threads in the system from being preempted
by the associated ISR, not just the thread that disabled the IRQ.</p>
</div>
</div>
<div class="section" id="offloading-isr-work">
<h3><a class="toc-backref" href="#id3">Offloading ISR Work</a><a class="headerlink" href="#offloading-isr-work" title="Permalink to this headline">¶</a></h3>
<p>An ISR should execute quickly to ensure predictable system operation.
If time consuming processing is required the ISR should offload some or all
processing to a thread, thereby restoring the kernel’s ability to respond
to other interrupts.</p>
<p>The kernel supports several mechanisms for offloading interrupt-related
processing to a thread.</p>
<ul class="simple">
<li>An ISR can signal a helper thread to do interrupt-related processing
using a kernel object, such as a fifo, lifo, or semaphore.</li>
<li>An ISR can signal an alert which causes the system workqueue thread
to execute an associated alert handler function.
(See <a class="reference internal" href="../synchronization/alerts.html#alerts-v2"><span class="std std-ref">Alerts</span></a>.)</li>
<li>An ISR can instruct the system workqueue thread to execute a work item.
(See TBD.)</li>
</ul>
<p>When an ISR offloads work to a thread, there is typically a single context
switch to that thread when the ISR completes, allowing interrupt-related
processing to continue almost immediately. However, depending on the
priority of the thread handling the offload, it is possible that
the currently executing cooperative thread or other higher-priority threads
may execute before the thread handling the offload is scheduled.</p>
</div>
</div>
<div class="section" id="implementation">
<h2><a class="toc-backref" href="#id4">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="defining-a-regular-isr">
<h3><a class="toc-backref" href="#id5">Defining a regular ISR</a><a class="headerlink" href="#defining-a-regular-isr" title="Permalink to this headline">¶</a></h3>
<p>An ISR is defined at runtime by calling <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a>. It must
then be enabled by calling <code class="xref cpp cpp-func docutils literal"><span class="pre">irq_enable()</span></code>.</p>
<div class="admonition important">
<p class="first admonition-title">Important</p>
<p class="last">IRQ_CONNECT() is not a C function and does some inline assembly magic
behind the scenes. All its arguments must be known at build time.
Drivers that have multiple instances may need to define per-instance
config functions to configure each instance of the interrupt.</p>
</div>
<p>The following code defines and enables an ISR.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define MY_DEV_IRQ  24       </span><span class="cm">/* device uses IRQ 24 */</span><span class="cp"></span>
<span class="cp">#define MY_DEV_PRIO  2       </span><span class="cm">/* device uses interrupt priority 2 */</span><span class="cp"></span>
<span class="cm">/* argument passed to my_isr(), in this case a pointer to the device */</span>
<span class="cp">#define MY_ISR_ARG  DEVICE_GET(my_device)</span>
<span class="cp">#define MY_IRQ_FLAGS 0       </span><span class="cm">/* IRQ flags. Unused on non-x86 */</span><span class="cp"></span>

<span class="kt">void</span> <span class="nf">my_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
   <span class="p">...</span> <span class="cm">/* ISR code */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">my_isr_installer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="p">...</span>
   <span class="n">IRQ_CONNECT</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">,</span> <span class="n">MY_DEV_PRIO</span><span class="p">,</span> <span class="n">my_isr</span><span class="p">,</span> <span class="n">MY_ISR_ARG</span><span class="p">,</span> <span class="n">MY_IRQ_FLAGS</span><span class="p">);</span>
   <span class="n">irq_enable</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">);</span>
   <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-a-direct-isr">
<h3><a class="toc-backref" href="#id6">Defining a ‘direct’ ISR</a><a class="headerlink" href="#defining-a-direct-isr" title="Permalink to this headline">¶</a></h3>
<p>Regular Zephyr interrupts introduce some overhead which may be unacceptable
for some low-latency use-cases. Specifically:</p>
<ul class="simple">
<li>The argument to the ISR is retrieved and passed to the ISR</li>
<li>If power management is enabled and the system was idle, all the hardware
will be resumed from low-power state before the ISR is executed, which can be
very time-consuming</li>
<li>Although some architectures will do this in hardware, other architectures
need to switch to the interrupt stack in code</li>
<li>After the interrupt is serviced, the OS then performs some logic to
potentially make a scheduling decision.</li>
</ul>
<p>Zephyr supports so-called ‘direct’ interrupts, which are installed via
<a class="reference internal" href="../../api/kernel_api.html#c.IRQ_DIRECT_CONNECT" title="IRQ_DIRECT_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_DIRECT_CONNECT</span></code></a>. These direct interrupts have some special
implementation requirements and a reduced feature set; see the definition
of <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_DIRECT_CONNECT" title="IRQ_DIRECT_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_DIRECT_CONNECT</span></code></a> for details.</p>
<p>The following code demonstrates a direct ISR:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define MY_DEV_IRQ  24       </span><span class="cm">/* device uses IRQ 24 */</span><span class="cp"></span>
<span class="cp">#define MY_DEV_PRIO  2       </span><span class="cm">/* device uses interrupt priority 2 */</span><span class="cp"></span>
<span class="cm">/* argument passed to my_isr(), in this case a pointer to the device */</span>
<span class="cp">#define MY_IRQ_FLAGS 0       </span><span class="cm">/* IRQ flags. Unused on non-x86 */</span><span class="cp"></span>

<span class="n">ISR_DIRECT_DECLARE</span><span class="p">(</span><span class="n">my_isr</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">do_stuff</span><span class="p">();</span>
   <span class="n">ISR_DIRECT_PM</span><span class="p">();</span> <span class="cm">/* PM done after servicing interrupt for best latency */</span>
   <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* We should check if scheduling decision should be made */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">my_isr_installer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
   <span class="p">...</span>
   <span class="n">IRQ_DIRECT_CONNECT</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">,</span> <span class="n">MY_DEV_PRIO</span><span class="p">,</span> <span class="n">my_isr</span><span class="p">,</span> <span class="n">MY_IRQ_FLAGS</span><span class="p">);</span>
   <span class="n">irq_enable</span><span class="p">(</span><span class="n">MY_DEV_IRQ</span><span class="p">);</span>
   <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="implementation-details">
<h3><a class="toc-backref" href="#id7">Implementation Details</a><a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h3>
<p>Interrupt tables are set up at build time using some special build tools.  The
details laid out here apply to all architectures except x86, which are
covered in the <a class="reference internal" href="#x86-details">x86 Details</a> section below.</p>
<p>Any invocation of <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a> will declare an instance of
struct _isr_list which is placed in a special .intList section:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">_isr_list</span> <span class="p">{</span>
    <span class="cm">/** IRQ line number */</span>
    <span class="n">s32_t</span> <span class="n">irq</span><span class="p">;</span>
    <span class="cm">/** Flags for this IRQ, see ISR_FLAG_* definitions */</span>
    <span class="n">s32_t</span> <span class="n">flags</span><span class="p">;</span>
    <span class="cm">/** ISR to call */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
    <span class="cm">/** Parameter for non-direct IRQs */</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Zephyr is built in two phases; the first phase of the build produces
zephyr_prebuilt.elf which contains all the entries in the .intList section
preceded by a header:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">spurious_irq_handler</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">sw_irq_handler</span><span class="p">;</span>
    <span class="n">u32_t</span> <span class="n">num_isrs</span><span class="p">;</span>
    <span class="n">u32_t</span> <span class="n">num_vectors</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">_isr_list</span> <span class="n">isrs</span><span class="p">[];</span>  <span class="o">&lt;-</span> <span class="n">of</span> <span class="n">size</span> <span class="n">num_isrs</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This data consisting of the header and instances of struct _isr_list inside
zephyr_prebuilt.elf is then used by the gen_isr_tables.py script to generate a
C file defining a vector table and software ISR table that are then compiled
and linked into the final application.</p>
<p>The priority level of any interrupt is not encoded in these tables, instead
<a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a> also has a runtime component which programs the desired
priority level of the interrupt to the interrupt controller. Some architectures
do not support the notion of interrupt priority, in which case the priority
argument is ignored.</p>
<div class="section" id="vector-table">
<h4>Vector Table<a class="headerlink" href="#vector-table" title="Permalink to this headline">¶</a></h4>
<p>A vector table is generated when CONFIG_GEN_IRQ_VECTOR_TABLE is enabled.  This
data structure is used natively by the CPU and is simply an array of function
pointers, where each element n corresponds to the IRQ handler for IRQ line n,
and the function pointers are:</p>
<ol class="arabic simple">
<li>For ‘direct’ interrupts declared with <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_DIRECT_CONNECT" title="IRQ_DIRECT_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_DIRECT_CONNECT</span></code></a>, the
handler function will be placed here.</li>
<li>For regular interrupts declared with <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a>, the address
of the common software IRQ handler is placed here. This code does common
kernel interrupt bookkeeping and looks up the ISR and parameter from the
software ISR table.</li>
<li>For interrupt lines that are not configured at all, the address of the
spurious IRQ handler will be placed here. The spurious IRQ handler
causes a system fatal error if encountered.</li>
</ol>
<p>Some architectures (such as the Nios II internal interrupt controller) have a
common entry point for all interrupts and do not support a vector table, in
which case the CONFIG_GEN_IRQ_VECTOR_TABLE option should be disabled.</p>
<p>Some architectures may reserve some initial vectors for system exceptions
and declare this in a table elsewhere, in which case
CONFIG_GEN_IRQ_START_VECTOR needs to be set to properly offset the indices
in the table.</p>
</div>
<div class="section" id="sw-isr-table">
<h4>SW ISR Table<a class="headerlink" href="#sw-isr-table" title="Permalink to this headline">¶</a></h4>
<p>This is an array of struct _isr_table_entry:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">struct</span> <span class="n">_isr_table_entry</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">isr</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>This is used by the common software IRQ handler to look up the ISR and its
argument and execute it. The active IRQ line is looked up in an interrupt
controller register and used to index this table.</p>
</div>
<div class="section" id="x86-details">
<h4>x86 Details<a class="headerlink" href="#x86-details" title="Permalink to this headline">¶</a></h4>
<p>The x86 architecture has a special type of vector table called the Interrupt
Descriptor Table (IDT) which must be laid out in a certain way per the x86
processor documentation.  It is still fundamentally a vector table, and the
gen_idt tool uses the .intList section to create it. However, on APIC-based
systems the indexes in the vector table do not correspond to the IRQ line. The
first 32 vectors are reserved for CPU exceptions, and all remaining vectors (up
to index 255) correspond to the priority level, in groups of 16. In this
scheme, interrupts of priority level 0 will be placed in vectors 32-47, level 1
48-63, and so forth. When the gen_idt tool is constructing the IDT, when it
configures an interrupt it will look for a free vector in the appropriate range
for the requested priority level and set the handler there.</p>
<p>There are some APIC variants (such as MVIC) where priorities cannot be set
by the user and the position in the vector table does correspond to the
IRQ line. Systems like this will enable CONFIG_X86_FIXED_IRQ_MAPPING.</p>
<p>On x86 when an interrupt or exception vector is executed by the CPU, there is
no foolproof way to determine which vector was fired, so a software ISR table
indexed by IRQ line is not used. Instead, the <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a> call
creates a small assembly language function which calls the common interrupt
code in <code class="xref cpp cpp-func docutils literal"><span class="pre">_interrupt_enter()</span></code> with the ISR and parameter as arguments.
It is the address of this assembly interrupt stub which gets placed in the IDT.
For interrupts declared with <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_DIRECT_CONNECT" title="IRQ_DIRECT_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_DIRECT_CONNECT</span></code></a> the parameterless
ISR is placed directly in the IDT.</p>
<p>On systems where the position in the vector table corresponds to the
interrupt’s priority level, the interrupt controller needs to know at
runtime what vector is associated with an IRQ line. gen_idt additionally
creates an _irq_to_interrupt_vector array which maps an IRQ line to its
configured vector in the IDT. This is used at runtime by <a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a>
to program the IRQ-to-vector association in the interrupt controller.</p>
</div>
</div>
</div>
<div class="section" id="suggested-uses">
<h2><a class="toc-backref" href="#id8">Suggested Uses</a><a class="headerlink" href="#suggested-uses" title="Permalink to this headline">¶</a></h2>
<p>Use a regular or direct ISR to perform interrupt processing that requires a
very rapid response, and can be done quickly without blocking.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Interrupt processing that is time consuming, or involves blocking,
should be handed off to a thread. See <a class="reference internal" href="#offloading-isr-work">Offloading ISR Work</a> for
a description of various techniques that can be used in an application.</p>
</div>
</div>
<div class="section" id="configuration-options">
<h2><a class="toc-backref" href="#id9">Configuration Options</a><a class="headerlink" href="#configuration-options" title="Permalink to this headline">¶</a></h2>
<p>Related configuration options:</p>
<ul class="simple">
<li><a class="reference internal" href="../../reference/kconfig/CONFIG_ISR_STACK_SIZE.html#cmdoption-arg-config-isr-stack-size"><code class="xref std std-option docutils literal"><span class="pre">CONFIG_ISR_STACK_SIZE</span></code></a></li>
</ul>
<p>Additional architecture-specific and device-specific configuration options
also exist.</p>
</div>
<div class="section" id="apis">
<h2><a class="toc-backref" href="#id10">APIs</a><a class="headerlink" href="#apis" title="Permalink to this headline">¶</a></h2>
<p>The following interrupt-related APIs are provided by <code class="file docutils literal"><span class="pre">irq.h</span></code>:</p>
<ul class="simple">
<li><a class="reference internal" href="../../api/kernel_api.html#c.IRQ_CONNECT" title="IRQ_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_CONNECT</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#c.IRQ_DIRECT_CONNECT" title="IRQ_DIRECT_CONNECT"><code class="xref c c-macro docutils literal"><span class="pre">IRQ_DIRECT_CONNECT</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#c.ISR_DIRECT_HEADER" title="ISR_DIRECT_HEADER"><code class="xref c c-macro docutils literal"><span class="pre">ISR_DIRECT_HEADER</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#c.ISR_DIRECT_FOOTER" title="ISR_DIRECT_FOOTER"><code class="xref c c-macro docutils literal"><span class="pre">ISR_DIRECT_FOOTER</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#c.ISR_DIRECT_PM" title="ISR_DIRECT_PM"><code class="xref c c-macro docutils literal"><span class="pre">ISR_DIRECT_PM</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#c.ISR_DIRECT_DECLARE" title="ISR_DIRECT_DECLARE"><code class="xref c c-macro docutils literal"><span class="pre">ISR_DIRECT_DECLARE</span></code></a></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">irq_lock()</span></code></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">irq_unlock()</span></code></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">irq_enable()</span></code></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">irq_disable()</span></code></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">irq_is_enabled()</span></code></li>
</ul>
<p>The following interrupt-related APIs are provided by <code class="file docutils literal"><span class="pre">kernel.h</span></code>:</p>
<ul class="simple">
<li><a class="reference internal" href="../../api/kernel_api.html#_CPPv211k_is_in_isrv" title="k_is_in_isr"><code class="xref cpp cpp-func docutils literal"><span class="pre">k_is_in_isr()</span></code></a></li>
<li><a class="reference internal" href="../../api/kernel_api.html#_CPPv219k_is_preempt_threadv" title="k_is_preempt_thread"><code class="xref cpp cpp-func docutils literal"><span class="pre">k_is_preempt_thread()</span></code></a></li>
</ul>
</div>
</div>


                </div>
              </div>
              <!-- 
  <div class="rst-footer-buttons row" role="navigation" aria-label="footer navigation">
    
      <a href="atomic.html" class="btn btn-neutral float-right" title="Atomic Services" accesskey="n">
        Next <span class="fa fa-arrow-circle-right"></span>
      </a>
    
    
      <a href="other.html" class="btn btn-neutral" title="Other Services" accesskey="p">
        <span class="fa fa-arrow-circle-left"></span> Previous
      </a>
    
  </div>
  for ZEP-463 remove the prev/next links -->
            </div>
            <!-- ENDS #content SECTION -->
          </section>
          <!-- ENDS .content -->
        </div>
        <!-- ENDS .main-container -->
      </div>
      <!-- ENDS #main -->
      <footer id="footer">
  <div class="container">
    <div class="block block-menu block-odd first block" data-bid="menu-footer-menu">
      <h3 class="title">Footer Menu</h3>
      <ul class="menu">
        <li class="leaf google- mid-2404">
          <a href="https://plus.google.com/+ZephyrProject" class="google-plus"><span>Google+</span></a>
        </li>
        <li class="leaf twitter mid-2405">
          <a href="https://twitter.com/zephyriot" class="twitter"><span>Twitter</span></a>
        </li>
        <li class="last leaf email mid-2406">
          <a href="mailto:info@zephyrproject.org" class="email"><span>Email</span></a>
        </li>
      </ul>
    </div>
    <div class="block block-block block-even block" data-bid="block-4">
      <p>
        Zephyr Project © 2018 is a Linux Foundation Project. All Rights Reserved.
      </p>
      <p>
        <a href="https://linuxfoundation.org" target="_blank">Linux Foundation</a> is a registered trademark of The Linux Foundation. Linux is a registered <a href="https://www.linuxfoundation.org/about/linux-foundation-trademark-usage-guidelines" target="_blank">trademark</a> of Linus Torvalds.
      </p>
      <p>
        Please see our <a href="https://www.linuxfoundation.org/privacy" target="_blank">privacy policy</a> and <a href="https://www.linuxfoundation.org/terms" target="_blank">terms of use</a>
      </p>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #page -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.10.99',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/main.js"></script>
      <script type="text/javascript" src="../../_static/js/app.js"></script>
      <script type="text/javascript" src="../../_static/js/affix.js"></script>

   

  </body>
</html>