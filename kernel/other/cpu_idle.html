

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en" > <!--<![endif]-->
  <head>
    <meta charset="utf-8">
   <!-- Google Tag Manager -->
   <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
   new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
   j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
   'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
   })(window,document,'script','dataLayer','GTM-KMP8MS');</script>
   <!-- End Google Tag Manager -->
    <link rel="apple-touch-icon" sizes="57x57" href="../../_static/img/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../../_static/img/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../../_static/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../../_static/img/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../../_static/img/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../../_static/img/apple-touch-icon-120x120.png">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/png" href="../../_static/img/favicon-16x16.png" sizes="16x16">
    <link rel="manifest" href="../../_static/manifest.json">
    <meta name="apple-mobile-web-app-title" content="Zephyr Project">
    <meta name="application-name" content="Zephyr Project">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    
    <title>CPU Idling &mdash; Zephyr Project Documentation</title>
    

    
    

    

    
    
      
    

    
    
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    

    
      <link rel="stylesheet" href="../../_static/zephyr-custom.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/normalize.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/layout.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/main.css" type="text/css" />
    
      <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
    

    
        <link rel="index" title="Index" href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
        <link rel="copyright" title="Copyright" href="../../copyright.html"/>
      <link rel="top" title="Zephyr Project Documentation" href="../../index.html"/>
        <link rel="up" title="Other Services" href="other.html"/>
        <link rel="next" title="Zephyr Project Security" href="../../security/security.html"/>
        <link rel="prev" title="C++ Support for Applications" href="cxx_support.html"/> 

    
    <script src="../../_static/js/modernizr.min.js"></script>

  </head>

  <body class="not-front page-documentation one-sidebar sidebar-first" role="document" >
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KMP8MS"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <div id="page">
      <header id="header">
  <div class="header-wrapper">
    <div class="container">
      <a href="https://zephyrproject.org/" title="Zephyr Project" rel="home" id="logo">
        <img src="../../_static/img/logo_white.png" alt="Zephyr Project">
      </a>
      <a href="" id="navigation-toggle">
        <span> </span>
        Menu
      </a>
      <nav id="navigation" class="menu with-primary with-secondary">
        <ul class="header-menu main-menu">
          <li class="first expanded about mid-1209"><a href="https://zephyrproject.org/about/"><span>About</span></a>
            <ul class="menu">
              <li class="first leaf what-is-zephyr mid-2563"><a href="https://zephyrproject.org/what-is-zephyr/"><span>What is the Zephyr Project?</span></a></li>
              <li class="leaf organization mid-2564"><a href="https://zephyrproject.org/about/organization/"><span>Organization</span></a></li>
              <li class="leaf memberships mid-2532"><a href="https://zephyrproject.org/#members"><span>Members</span></a></li>
              <li class="leaf faq mid-2525"><a href="https://zephyrproject.org/about/#faq"><span>FAQ</span></a></li>
              <li class="leaf join mid-2622"><a href="https://zephyrproject.org/join/"><span>Join</span></a></li>
              <li class="last leaf contact-us mid-2530"><a href="https://zephyrproject.org/about/#contact-us"><span>Contact Us</span></a></li>
            </ul>
          </li>
          <li class="expanded developers mid-1209"><a href="https://zephyrproject.org/developers/"><span>Developers</span></a>
            <ul class="menu">
              <li class="first expanded leaf code mid-2563"><a href="https://github.com/zephyrproject-rtos/zephyr/" target="_blank"><span>Code</span></a></li>
              <li class="leaf downloads mid-2564"><a href="https://zephyrproject.org/developers/#downloads"><span>Downloads</span></a></li>
              <li class="leaf documentation mid-2564"><a href="http://docs.zephyrproject.org/index.html" target="_blank"><span>Documentation</span></a></li>
              <li class="leaf supported-boards mid-2564"><a href="http://docs.zephyrproject.org/boards/boards.html" target="_blank"><span>Supported Boards</span></a></li>
              <li class="leaf releases-overview mid-2564"><a href="https://zephyrproject.org/developers/#releases-overview"><span>Releases Overview</span></a></li>
              <li class="leaf how-to-contribute mid-2564"><a href="https://zephyrproject.org/developers/how-to-contribute/"><span>How to Contribute</span></a></li>
              <li class="last leaf community-guidelines mid-2564"><a href="https://zephyrproject.org/developers/how-to-contribute/#community-guidelines"><span>Community Guidelines</span></a></li>
            </ul>
          </li>
          <li class="expanded news mid-1209"><a href="https://zephyrproject.org/news/"><span>News</span></a>
            <ul class="menu">
              <li class="first leaf announcements mid-2563"><a href="https://zephyrproject.org/news/announcements/"><span>Announcements</span></a></li>
              <li class="leaf blog mid-2563"><a href="https://zephyrproject.org/news/blog/"><span>Blog</span></a></li>
              <li class="last leaf events mid-2563"><a href="https://zephyrproject.org/events/"><span>Events</span></a></li>
            </ul>
          </li>
          <li class="last expanded project-resources mid-1209"><a href="https://zephyrproject.org/project-resources/"><span>Project Resources</span></a>
            <ul class="menu">
              <li class="first leaf presentations mid-2563"><a href="https://zephyrproject.org/project-resources/presentations/"><span>Presentations</span></a></li>
              <li class="leaf videos mid-2563"><a href="https://zephyrproject.org/project-resources/videos/"><span>Videos</span></a></li>
              <li class="leaf demos mid-2563"><a href="https://zephyrproject.org/project-resources/demos/"><span>Demos</span></a></li>
              <li class="leaf zephyr-in-market mid-2563"><a href="https://zephyrproject.org/project-resources/zephyr-in-market/"><span>Zephyr in Market</span></a></li>
              <li class="last leaf developer-tools mid-2563"><a href="https://zephyrproject.org/project-resources/developer-tools/"><span>Developer Tools</span></a></li>
            </ul>
          </li>
        </ul>
      </nav><!-- /navigation -->
    </div>
  </div>
</header><!-- /header -->
      <!-- STARTS #main -->
      <div id="main">
        <!-- STARTS .main-container -->
        <div class="main-container">
          

 



<!-- Docs -->





<div id="breadcrumb">
  <div class="container">
    <a href="/">Home</a> / 
    <a href="../../index.html">Docs</a> /
      
          <a href="../kernel.html">Zephyr Kernel Primer</a> /
      
          <a href="other.html">Other Services</a> /
      
  </div>
</div>
          <aside id="sidebar-first" class="container-sidebar">
            
            <span id="secondary-menu-button" class="">Documentation</span>
<div class="region region-sidebar">
  <div class="docs-menu">
  
    
    
        <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../introduction/introducing_zephyr.html">Introducing Zephyr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contribute/contribute.html">Contributing to the Zephyr Project</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../kernel.html">Zephyr Kernel Primer</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../overview/overview.html">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="../threads/threads.html">Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../timing/timing.html">Timing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory/memory.html">Memory Allocation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../synchronization/synchronization.html">Synchronization</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_passing/data_passing.html">Data Passing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usermode/usermode.html">User Mode</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="other.html">Other Services</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="interrupts.html">Interrupts</a></li>
<li class="toctree-l3"><a class="reference internal" href="atomic.html">Atomic Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="polling.html">Polling API</a></li>
<li class="toctree-l3"><a class="reference internal" href="ring_buffers.html">Ring Buffers</a></li>
<li class="toctree-l3"><a class="reference internal" href="float.html">Floating Point Services</a></li>
<li class="toctree-l3"><a class="reference internal" href="cxx_support.html">C++ Support for Applications</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">CPU Idling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../security/security.html">Zephyr Project Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../application/index.html">Developer Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boards/boards.html">Supported Boards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../devices/index.html">Device and Driver Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../subsystems/subsystems.html">Subsystems</a></li>
</ul>

    
  
  </div>
<div role="search" class="sphinx-search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search documentation" class="search-documentation" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
</div>
          </aside>
          <!-- STARTS .content SECTION-->
          <section id="content" class="row">
            
	    
            <div class="rst-content">
              <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
                <div itemprop="articleBody">
                  
  <div class="section" id="cpu-idling">
<span id="cpu-idle"></span><h1>CPU Idling<a class="headerlink" href="#cpu-idling" title="Permalink to this headline">¶</a></h1>
<p>Although normally reserved for the idle thread, in certain special
applications, a thread might want to make the CPU idle.</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#concepts" id="id1">Concepts</a></li>
<li><a class="reference internal" href="#implementation" id="id2">Implementation</a><ul>
<li><a class="reference internal" href="#making-the-cpu-idle" id="id3">Making the CPU idle</a></li>
<li><a class="reference internal" href="#making-the-cpu-idle-in-an-atomic-fashion" id="id4">Making the CPU idle in an atomic fashion</a></li>
</ul>
</li>
<li><a class="reference internal" href="#suggested-uses" id="id5">Suggested Uses</a></li>
<li><a class="reference internal" href="#apis" id="id6">APIs</a></li>
</ul>
</div>
<div class="section" id="concepts">
<h2><a class="toc-backref" href="#id1">Concepts</a><a class="headerlink" href="#concepts" title="Permalink to this headline">¶</a></h2>
<p>Making the CPU idle causes the kernel to pause all operations until an event,
normally an interrupt, wakes up the CPU. In a regular system, the idle thread
is responsible for this. However, in some constrained systems, it is possible
that another thread takes this duty.</p>
</div>
<div class="section" id="implementation">
<h2><a class="toc-backref" href="#id2">Implementation</a><a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="making-the-cpu-idle">
<h3><a class="toc-backref" href="#id3">Making the CPU idle</a><a class="headerlink" href="#making-the-cpu-idle" title="Permalink to this headline">¶</a></h3>
<p>Making the CPU idle is simple: call the k_cpu_idle() API. The CPU will stop
executing instructions until an event occurs. Make sure interrupts are not
locked before invoking it. Most likely, it will be called within a loop.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">k_sem</span> <span class="n">my_sem</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">my_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">k_sem_give</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">k_sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="cm">/* wait for semaphore from ISR, then do related work */</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

        <span class="cm">/* wait for ISR to trigger work to perform */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k_sem_take</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">,</span> <span class="n">K_NO_WAIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

            <span class="cm">/* ... do processing */</span>

        <span class="p">}</span>

        <span class="cm">/* put CPU to sleep to save power */</span>
        <span class="n">k_cpu_idle</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="making-the-cpu-idle-in-an-atomic-fashion">
<h3><a class="toc-backref" href="#id4">Making the CPU idle in an atomic fashion</a><a class="headerlink" href="#making-the-cpu-idle-in-an-atomic-fashion" title="Permalink to this headline">¶</a></h3>
<p>It is possible that there is a need to do some work atomically before making
the CPU idle. In such a case, k_cpu_atomic_idle() should be used instead.</p>
<p>In fact, there is a race condition in the previous example: the interrupt could
occur between the time the semaphore is taken, finding out it is not available
and making the CPU idle again. In some systems, this can cause the CPU to idle
until <em>another</em> interrupt occurs, which might be <em>never</em>, thus hanging the
system completely. To prevent this, k_cpu_atomic_idle() should have been used,
like in this example.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="n">k_sem</span> <span class="n">my_sem</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">my_isr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">k_sem_give</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">k_sem_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">key</span> <span class="o">=</span> <span class="n">irq_lock</span><span class="p">();</span>

        <span class="cm">/*</span>
<span class="cm">         * Wait for semaphore from ISR; if acquired, do related work, then</span>
<span class="cm">         * go to next loop iteration (the semaphore might have been given</span>
<span class="cm">         * again); else, make the CPU idle.</span>
<span class="cm">         */</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">k_sem_take</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_sem</span><span class="p">,</span> <span class="n">K_NO_WAIT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

            <span class="n">irq_unlock</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>

            <span class="cm">/* ... do processing */</span>


        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* put CPU to sleep to save power */</span>
            <span class="n">k_cpu_atomic_idle</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="suggested-uses">
<h2><a class="toc-backref" href="#id5">Suggested Uses</a><a class="headerlink" href="#suggested-uses" title="Permalink to this headline">¶</a></h2>
<p>Use k_cpu_atomic_idle() when a thread has to do some real work in addition to
idling the CPU to wait for an event. See example above.</p>
<p>Use k_cpu_idle() only when a thread is only responsible for idling the CPU,
i.e. not doing any real work, like in this example below.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* ... do some system/application initialization */</span>


    <span class="cm">/* thread is only used for CPU idling from this point on */</span>
    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="n">k_cpu_idle</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Do not use these APIs unless absolutely necessary.</strong> In a normal system,
the idle thread takes care of power management, including CPU idling.</p>
</div>
</div>
<div class="section" id="apis">
<h2><a class="toc-backref" href="#id6">APIs</a><a class="headerlink" href="#apis" title="Permalink to this headline">¶</a></h2>
<p>The following CPU idling APIs are provided by <code class="file docutils literal"><span class="pre">kernel.h</span></code>:</p>
<ul class="simple">
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">k_cpu_idle()</span></code></li>
<li><code class="xref cpp cpp-func docutils literal"><span class="pre">k_cpu_atomic_idle()</span></code></li>
</ul>
</div>
</div>


                </div>
              </div>
              <!-- 
  <div class="rst-footer-buttons row" role="navigation" aria-label="footer navigation">
    
      <a href="../../security/security.html" class="btn btn-neutral float-right" title="Zephyr Project Security" accesskey="n">
        Next <span class="fa fa-arrow-circle-right"></span>
      </a>
    
    
      <a href="cxx_support.html" class="btn btn-neutral" title="C++ Support for Applications" accesskey="p">
        <span class="fa fa-arrow-circle-left"></span> Previous
      </a>
    
  </div>
  for ZEP-463 remove the prev/next links -->
            </div>
            <!-- ENDS #content SECTION -->
          </section>
          <!-- ENDS .content -->
        </div>
        <!-- ENDS .main-container -->
      </div>
      <!-- ENDS #main -->
      <footer id="footer">
  <div class="container">
    <div class="block block-menu block-odd first block" data-bid="menu-footer-menu">
      <h3 class="title">Footer Menu</h3>
      <ul class="menu">
        <li class="leaf google- mid-2404">
          <a href="https://plus.google.com/+ZephyrProject" class="google-plus"><span>Google+</span></a>
        </li>
        <li class="leaf twitter mid-2405">
          <a href="https://twitter.com/zephyriot" class="twitter"><span>Twitter</span></a>
        </li>
        <li class="last leaf email mid-2406">
          <a href="mailto:info@zephyrproject.org" class="email"><span>Email</span></a>
        </li>
      </ul>
    </div>
    <div class="block block-block block-even block" data-bid="block-4">
      <p>
        Zephyr Project © 2018 is a Linux Foundation Project. All Rights Reserved.
      </p>
      <p>
        <a href="https://linuxfoundation.org" target="_blank">Linux Foundation</a> is a registered trademark of The Linux Foundation. Linux is a registered <a href="https://www.linuxfoundation.org/about/linux-foundation-trademark-usage-guidelines" target="_blank">trademark</a> of Linus Torvalds.
      </p>
      <p>
        Please see our <a href="https://www.linuxfoundation.org/privacy" target="_blank">privacy policy</a> and <a href="https://www.linuxfoundation.org/terms" target="_blank">terms of use</a>
      </p>
    </div>
  </div>
</footer>
    </div>
    <!-- ENDS #page -->

  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.10.99',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../_static/js/main.js"></script>
      <script type="text/javascript" src="../../_static/js/app.js"></script>
      <script type="text/javascript" src="../../_static/js/affix.js"></script>

   

  </body>
</html>